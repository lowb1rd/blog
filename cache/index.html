<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <title>No nix narrets! - neunzehn83.de</title>
    
    <link rel="stylesheet" href="/blog/www/css/reset.css" media="screen,projection" />
    <link rel="stylesheet" href="/blog/www/css/style.css" media="screen,projection" />
    <link rel="alternate" type="application/rss+xml" title="RSS-Feed neunzehn83.de" href="/blog/www/feed.xml" />
    <link rel="shortcut icon" href="favicon.ico" />

    <meta name="description" content="Mein Blog über Dies &amp; Das, Sel' und Jenes, Webtechnik im Speziellen und Computer im Allgemeinen." />    

    <!--[if lt IE 9]>
        <script src="/blog/www/js/ie.js"></script> 
    <![endif]-->   
</head>
<body>
    <header>
        <h1><a href="/blog/www">neunzehn83.de</a></h1>
        <h2>Ein Mann, ein Blog, kein Plan.</h2>
        <nav>
            <ul>
                <li><a href="https://github.com/lowb1rd">Github</a></li>
                <li><a href="/blog/www/about.html">About me</a></li>
                <li><a href="http://twitter.com/Bolle">Twitter</a></li>
            </ul>
        </nav>
    </header>    
    
    <div>
        <script>document.write('<img src="/blog/www/images/header/bild'+(1+parseInt(Math.random()*15))+'.jpg" alt="" width="810" height="150" />'); </script>        <noscript><img src="/blog/www/images/header/bild10.jpg" alt="" width="810" height="150" /></noscript>                 <article>            <time pubdate>14. Februar 2012</time>            <h1><a href="/blog/www/2012/02/14/ipv6-und-die-dimension.html">IPv6 und die Dimension</a></h1>            <p>Ja, so ganz durch ist das Thema IPv6 hier noch nicht - aber bald, versprochen! Also, einen noch:</p>

<p>IPv4-Adressen werden knapp. So wie das Öl. Das weiß jeder. Bei Hetzner ist für Zusatz-Subnetze jetzt schon ein monatlicher Beitrag fällig und Hosteurope stellt unangenehme Fragen bei der Beantragung:</p>

<blockquote>
  <p>Sehr geehrte Kundin,
  sehr geehrter Kunde,</p>
  
  <p>Ihren Antrag auf weitere IP-Adressen müssen wir zurückweisen.</p>
  
  <p>Die Verknappung an IPv4-Adressen erfordert es, dass die verbleibenden Adressen sparsam zugewiesen werden.</p>
  
  <p>Sie verfügen bereits über X IP-Adressen, die nach derzeitigem Stand nicht voll genutzt werden. Zumindest lassen die Trafficstatistiken und der Content dies vermuten.</p>
</blockquote>

<p>Dabei ist die Situation hier in Europa noch völlig entspannt, da "unsere" Vergabestelle, die RIPE, im Gegensatz zur APNIC noch einige /8 in petto hat.</p>

<p>Es gibt insgesamt knapp über 4 Milliarden IPv4-Adressen, aber noch lange nicht so viele Hosts im Internet. Vielmehr ist im Moment das Problem, dass <a href="//en.wikipedia.org/wiki/List_of_assigned_/8_IPv4_address_blocks">die wenigen "Großen" von damals</a>, großzügig wie man war, ganze /8 Netze zugeteilt bekommen haben. Ein /8, auch Class A Netz genannt, sind über 16 Millionen IP-Adressen - nur die wenigsten haben oder werden jemals so viele IP-Adressen brauchen. Das ist auch der Grund, warum der ein oder andere bereit ist, <a href="//diepresse.com/home/techscience/hightech/microsoft/644749/IPAdressen-knapp_Microsoft-kauft-Nachschub-ein">ein paar IP-Adressen abzugeben</a>.</p>

<p>Wie dem auch sei, IPv4 Adressen werden früher oder später ausgehen und IPv6 wird kommen. Der Weg dorthin ist lang und die Fortschritte hier in Deutschland eher zäh. So ist mir noch kein ISP bekannt, der seinen Kunden IPv6 anbietet. Selbst große Hoster wie Hosteurope bieten noch keinen IPv6-Support bei dezidierten Servern an. In 2011 betrug der Anteil an IPv6-Traffic gerade einmal 0.3%.</p>

<p>Damit man in wenigen Jahren nicht noch einmal so blöd dasteht, haben sich die schlauen Köpfe, die IPv6 erfunden haben, gedacht, wir machen die Adressen gleich 4 mal so lang, also statt 32 Bit ganze 128 Bit. Das hört sich jetzt nicht so sehr viel mehr an, ist es aber, wenn man bedenkt, dass sich mit jedem hinzugefügten Bit der vorhandene Adressraum <strong>verdoppelt</strong>. Das erinnert an das Schachbrett und die Reiskörner, und wir wissen alle wie diese Geschichte ausging..</p>

<p>Um die Anzahl der möglichen IPv6 Adressen zu nennen, empfiehlt sich aus Platzgründen die Exponentialschreibweise. Es sind: 3,4×10^38 Adressen, oder anders ausgedrückt: 22 Billiarden Adressen pro Quadratmillimeter Erde - Landmasse wohlgemerkt! Laut den <a href="http://www.ripe.net/docs/ripe-512#assignment_size">IPv6-Richtlinien</a> ist das kleinste, dem Endkunden zuteilbare Netz ein /64, was immerhin stolze 18 Trillionen Adressen beinhaltet - das ist das gesamte v4-Internet im Quadrat!</p>

<p>Die Umstellung auf IPv6 wird Jahre dauern, im Moment sieht es eher nach Jahrzehnten aus. Der Enduser bekommt von dem allen nicht viel mit: IPv4 und IPv6 werden so lange in friedlicher Koexistenz leben. Schade nur, dass man die Vorteile von IPv6 während dieser <em>Übergangszeit</em> gar nicht ausspielen kann. Ich fürchte, ich muss für einen zusätzlichen SSL-vHost in 10 Jahren immer noch <em title="SNI mal außen vor">bei meinem Hoster um eine IPv4 betteln</em>, da man es sich lange Zeit nicht leisten kann, IPv6-only Webseiten zu betreiben. Ich wage sogar zu behaupten, dass ich den Tag an dem der letzte IPv4-Nameserver abgeschalten wird, nicht mehr erlebe. Das ist aber nur eine Momentaufnahme und die Entwicklung wird sich bei tatsächlicher Knappheit dramatisch beschleunigen. Hoffentlich.</p>
        </article>                 <article>            <time pubdate>06. Februar 2012</time>            <h1><a href="/blog/www/2012/02/06/neuerungen-in-php-5-4.html">Neuerungen in PHP 5.4</a></h1>            <p>PHP 5.4 ist <a href="https://svn.php.net/repository/php/php-src/tags/php_5_4_0RC7/NEWS">schon bei RC7</a>, steht also sozusagen vor der Türe und schafft es wohl auch in das nächste Debian stable alias Wheezy. Wie auch schon bei 5.2->5.3 kommen einige nette und über Jahre in den PHP-RFC diskutierten Features hinzu. Die meisten davon sind eigentlich nur Abkürzungen, sparen also die ein oder andere Zeile Code ein. Dennoch gehören diese zu den meistgelobten Änderungen von PHP 5.4. Ich finde, zurecht! Als da wären:</p>

<h2>Short Array Syntax</h2>

<p>Javascript-Style Array notation</p>

<pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #000088;">$a</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">3</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
<span style="color: #000088;">$b</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'foo'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'orange'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'bar'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'apple'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">?&gt;</span></pre>

<h2>Function Array Dereferencing</h2>

<p>Ist der Rückgabewert einer Funktion ein Array, so kann direkt mit eckiger Klammer auf die Elemente zugegriffen werden.</p>

<pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #000000; font-weight: bold;">function</span> fruits<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
  <span style="color: #b1b100;">return</span> <span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'apple'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'banana'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'orange'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
<span style="color: #b1b100;">echo</span> fruits<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Outputs: apple</span>
<span style="color: #000000; font-weight: bold;">?&gt;</span></pre>

<h2>Short Open Tag echo</h2>

<p><code>&lt;?=</code>  ist jetzt immer, also auch bei ausgeschalteten short_open_tags verfügbar. Yay!</p>

<h2>Instance Method Call</h2>

<p>In PHP 5.4 ist es möglich, direkt nach Erzeugung eines Objektes mit dem <code>new</code> Keyword zu chainen. Hier hat man bei PHP5.3 zunächst das Objekt in einer Variable speichern müssen und konnte dann von dort aus chainen.</p>

<pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #000088;">$obj</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">new</span> foo<span style="color: #009900;">&#41;</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">bar</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">?&gt;</span></pre>

<p>Außerdem: <a href="http://php.net/traits">Traits</a>, schneller(er) @-Operator, default charset UTF-8, kein safe_mode/register_globals/magic_quotes mehr.</p>
        </article>                 <article>            <time pubdate>29. Januar 2012</time>            <h1><a href="/blog/www/2012/01/29/postfix-reject_sender_login_mismatch-pro-sasl-username.html">Postfix: reject_sender_login_mismatch pro SASL username</a></h1>            <p><em>Die Postfix-Konfiguration kann einem einige graue Haare verursachen, so wie bei dieser Problemstellung hier. Ich habe manchmal den Eindruck, dass Postfix gar nicht dazu entwickelt worden ist, E-Mails zu senden und zu empfangen, aber dennoch so flexibel ist, dass es sich irgendwie zu einem smtpd konfigurieren lässt..</em></p>

<p>Prinzipiell erlaubt Postfix mit <code>permit_sasl_authenticated</code> <em>jedem</em> SASL-authentifizierten Benutzer beliebige <strong>FROM</strong> E-Mail-Adressen zu verwenden. Mit der Option <code>reject_sender_login_mismatch</code> wird dieses Verhalten verboten und überprüft ob der SASL-Username bzw. die damit verknüpften Mail-Adressen und -Aliase mit dem <strong>FROM</strong> der E-Mail übereinstimmt.</p>

<p>Wenn man die Option reject_sender_login_mismatch nun nur auf bestimmte SASL-Usernamen beschränken will, wird es kompliziert. Das lässt sich nämlich nicht so einfach in der Postfix-Konfiguration (main.cf) einstellen, da sämtliche Lookup-Tables nicht den SASL-Username als Index benutzen.</p>

<h2>Was wir wollen</h2>

<p>Der User <strong>foo@example.org</strong> soll ausschließlich E-Mails mit foo@example.org als Absender senden können.<br />
Der User <strong>bar@example.org</strong> soll hingegen beliebige Absenderadressen wählen können.</p>

<p>Das geht nur über einen <a href="//www.postfix.org/SMTPD_POLICY_README.html">Policy Daemon</a>: Hört sich kompliziert an, ist aber im einfachsten Fall ein simples Script, dem von Postfix unter anderem der SASL-Username übergeben wird.</p>

<h1>smtpd Policy Daemon mit PHP</h1>

<p>Das funktioniert mit anderen Scriptsprachen wie Python oder Perl natürlich ähnlich, und wahrscheinlich sogar besser, wir machen das aber mal, weil wir es können, mit PHP!</p>

<p>Unser PHP Policy Daemon soll unter <code>/usr/local/bin/policyd</code> liegen (chmod +x nicht vergessen, chroot beachten). Die Parameter von Postfix kommen über STDIN. Das Ergebnis geben wir ganz normal über <code>echo</code> an Postfix zurück. Als Ergebnis kommt ACCEPT oder REJECT in Frage, oder aber jede bekannte Postfix UCE restriction, also auch reject_sender_login_mismatch! (Siehe dazu auch <a href="http://www.postfix.org/access.5.html">access(5)</a>)</p>

<p><strong>/usr/local/bin/policyd</strong></p>

<pre class="php" style="font-family:monospace;"><ol start="1"><li>#!/usr/bin/php
</li><li><span style="color: #000000; font-weight: bold;">&lt;?php</span>
</li><li><span style="color: #000088;">$allow_relay</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span>
</li><li>    <span style="color: #0000ff;">'bar@example.org'</span><span style="color: #339933;">,</span>
</li><li><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
</li><li>&nbsp;
</li><li><span style="color: #000088;">$fp</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/fopen"><span style="color: #990000;">fopen</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'php://stdin'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'r'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
</li><li><span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #009900; font-weight: bold;">true</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
</li><li>    <span style="color: #000088;">$line</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/fgets"><span style="color: #990000;">fgets</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$fp</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">512</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
</li><li>    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/strpos"><span style="color: #990000;">strpos</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$line</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'='</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
</li><li>        <a href="http://www.php.net/list"><span style="color: #990000;">list</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$k</span><span style="color: #339933;">,</span> <span style="color: #000088;">$v</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/explode"><span style="color: #990000;">explode</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'='</span><span style="color: #339933;">,</span> <a href="http://www.php.net/trim"><span style="color: #990000;">trim</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$line</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
</li><li>        <span style="color: #000088;">$env</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$k</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$v</span><span style="color: #339933;">;</span>
</li><li>    <span style="color: #009900;">&#125;</span>  
</li><li>    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$line</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span> <span style="color: #b1b100;">break</span><span style="color: #339933;">;</span>
</li><li><span style="color: #009900;">&#125;</span>
</li><li><a href="http://www.php.net/fclose"><span style="color: #990000;">fclose</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$fp</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
</li><li>&nbsp;
</li><li><span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$env</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'sasl_username'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
</li><li>    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><a href="http://www.php.net/in_array"><span style="color: #990000;">in_array</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$env</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'sasl_username'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #000088;">$allow_relay</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
</li><li>        <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;action=reject_sender_login_mismatch<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">;</span>
</li><li>        <a href="http://www.php.net/die"><span style="color: #990000;">die</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
</li><li>    <span style="color: #009900;">&#125;</span>
</li><li><span style="color: #009900;">&#125;</span>
</li><li><span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;action=DUNNO<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">;</span></li></ol></pre>

<p>Simple String-Funktionen: Ist der sasl_username <strong>nicht</strong> in unserem Array mit erlaubten Relay-Logins, wird die reject_sender_login_mismatch UCE restriction zurück gegeben. Das FROM muss nun also mit sasl_username übereinstimmen. Im anderen Fall wird ein "DUNNO" zurückgegeben, was Postfix dazu veranlasst mit der nächsten Regel weiter zu machen. reject_sender_login_mismatch gilt dann für diesen sasl_username also nicht.</p>

<p>Wichtig ist hier, den STDIN mit <code>fgets</code> zeilenweise zu lesen und aufzuhören sobald eine leere Zeile empfangen wird. Versucht man den gesamten STDIN über file_get_contents zu holen, beträgt der Timeout 60 Sekunden bis das Script fortgeführt wird und Postfix das Ergebnis übergeben werden kann.</p>

<p>Neben dem sasl_username kommen über STDIN noch weitere Parameter, wie z.B. die Absender-Adresse, Empfänger-Adresse oder die Client-IP. Eine vollständige Übersicht gibt es hier: <a href="//www.postfix.org/SMTPD_POLICY_README.html#protocol">http://www.postfix.org/SMTPD_POLICY_README.html#protocol</a></p>

<h2>Postfix Konfiguration</h2>

<p><strong>master.cf</strong></p>

<pre><code>policy  unix    -       n       n       -       0       spawn
    user=nobody argv=/usr/local/bin/policyd
</code></pre>

<p><strong>main.cf</strong></p>

<pre><code>smtpd_sender_restrictions = permit_mynetworks,
    <strong>check_policy_service unix:private/policy,</strong>
    permit_sasl_authenticated,
    [..]   

~$ /etc/init.d/postfix restart
</code></pre>

<p>Das wars!</p>
        </article>                 <article>            <time pubdate>12. Januar 2012</time>            <h1><a href="/blog/www/2012/01/12/neunzehn83-de-jetzt-auch-uber-ipv6-erreichbar.html">neunzehn83.de jetzt auch über IPv6 erreichbar</a></h1>            <p>Dank IPv6 zu Hause über den Tunnelbroker <a href="//www.sixxs.net">Sixxs</a> konnte ich nun endlich meinen vServer fit für "das neue Internet" machen. Natives IPv6 ist wohl in absehbarer Zeit nicht zu erwarten, da von meinem ISP, der Kabel Baden-Württemberg GmbH, noch kein Termin zur Einführung von IPv6 genannt wurde.</p>

<p><img src="/blog/www/images/2012/v6ping.gif" alt="v6ping" /></p>

<h2>Eigentlich ganz einfach</h2>

<p>Alles was wir brauchen ist:</p>

<ul>
<li>eine IPv6-Adresse</li>
<li>einen Nameserver, der per IPv6 erreichbar ist</li>
<li>DNS AAAA-Records</li>
<li>Apache für den Dualstack-Betrieb konfigurieren</li>
</ul>

<h3>Eine IPv6-Adresse</h3>

<p>Der <a href="//www.netcup.de/bestellen/produkt.php?produkt=88">vServer ALUMINIUM</a> von <a href="//www.netcup.de">Netcup</a>, auf dem neunzehn83.de läuft, ist IPv6 fähig. Per OpenVCP-Panel kann man bis zu 15 einzelne IPv6-Adressen aktivieren. Nach einem Reboot stehen diese zur Verfügung.</p>

<pre><code>~$ sudo ifconfig
eth0      Link encap:Ethernet  HWaddr 00:24:21:b4:xy:ab
      inet addr:188.40.201.74  Bcast:188.40.201.127  Mask:255.255.255.192
      inet6 addr: 2a01:4f8:100:5462:0:bc28:c94a:1/64 Scope:Global
      inet6 addr: 2a01:4f8:100:5462:0:bc28:c94a:2/64 Scope:Global
</code></pre>

<h3>Nameserver</h3>

<p>Für IPv4 schreibt die DeNIC mindestens zwei Nameserver in unterschiedlichen /24 Netzen vor. Bei IPv6 genügt im Moment noch ein einziger. <a href="/blog/www/2009/12/11/die-technik-hinter-diesem-blog-hosting-fur-schwaben.html">Wie bereits erwähnt</a>, verwende ich die Nameserver von <a href="//www.regworld.com">Regworld</a>, meinem Domain-Registrar. Zusätzlich läuft auf dem vServer noch ein Bind Nameserver als zweiter Secondary. Dieser lauscht auch gleichzeitig an der IPv6-Adresse und wird somit als einziger Nameserver für IPv6-Anfragen genutzt.</p>

<p>Die Nameserver von Regworld kommen dafür leider nicht in Frage, da diese (noch) nicht per IPv6 erreichbar sind. Das lässt sich aber relativ leicht lösen, indem man einen Bind-Nameserver an eine oder mehrere IPv6 adressen binded und als reinen Forwarder für die Regworld-Nameserver via IPv4 konfiguriert.</p>

<p>In meinem Fall gebe ich mich aber mal mangels RAM mit nur einem Nameserver für IPv6 zufrieden.</p>

<p>Zu guter Letzt muss noch ein IPv6 GLUE-Record für den Nameserver angelegt werden. Das geht im Domainrobot von Regworld (AutoDNS) genau so wie bei IPv4: Man schreibt den IPv6-Glue einfach per Leerzeichen vom v4-Glue getrennt dahinter:</p>

<pre><code>ns.example.org 1.1.1.1 ::1
</code></pre>

<p>Beim DeNIC-Whois sieht das dann so aus:</p>

<p><img src="/blog/www/images/2012/ipv6_nameserver_denic.gif" alt="ipv6_nameserver_denic" /></p>

<h3>DNS AAAA-Records</h3>

<p>Was der A-Record bei v4 ist der AAAA (Quad-A) Record bei v6. Diesen legen wir jetzt also für die Domain (neunzehn83.de) und die www-Subdomain an. Zusätzlich habe ich eine neue Subdomain <a href="//ipv6.neunzehn83.de">ipv6.neunzehn83.de</a> erstellt, die nur ein AAAA aber kein A Record hat, somit also exklusiv über IPv6 erreichbar ist.</p>

<pre><code>@    IN A    188.40.201.74    
@    IN AAAA 2a01:4f8:100:5462::bc28:c94a:1
www  IN A    188.40.201.74
www  IN AAAA 2a01:4f8:100:5462::bc28:c94a:1
ipv6 IN AAAA 2a01:4f8:100:5462::bc28:c94a:1
</code></pre>

<p>IPv6 hat übrigens Priorität vor IPv4, weshalb alle Besucher die sowohl mit IPv4 als auch mit IPv6 unterwegs sind, diese Webseite bereits über IPv6 betrachten.</p>

<h3>Apache Dualstack</h3>

<p>Dual-Stack nennt man das Verfahren, bei dem der Apache sowohl per IPv4 also auch per IPv6 erreichbar ist. Alles was dafür nötig ist, ist den Apachen auch auf der IPv6-Adresse lauschen zu lassen und die Virtualhost-Konfiguration um die IPv6-Adresse zu erweitern.</p>

<pre><code>Listen 188.40.201.74:80
Listen [2a01:4f8:100:5462::bc28:c94a:1]:80

&lt;Virtualhost 188.40.201.74:80 [2a01:4f8:100:5462::bc28:c94a:1]:80&gt;
[...]
&lt;/Virtualhost&gt;
</code></pre>

<p>Nach einem Apache-Restart ist alles klar.</p>

<h2>IPv6 und Froxlor</h2>

<p>Dummerweise schreibe ich für diesen Server die Apache-Configs nicht selbst, sondern lass das <a href="//www.froxlor.org/">Froxlor</a> machen. Froxlor ist der Nachfolger von SysCP, unterstützt aber ebenso noch kein Dualstack, weshalb ich selbst an der Source Hand angelegt habe. Alle Änderungen finden sich in <a href="/blog/www/files/2012/IPv6.patch">diesem Patch</a>, welchen ich auch in einem <a href="//forum.froxlor.org/index.php?/topic/1415-ipv6-dualstack-apache-bind/">Thread bei Froxlor</a> zur Diskussion veröffentlicht habe. In der Datenbank muss die Varchar-Länge des <code>ip</code>-Feldes der <code>panel_ipsandports</code>-Tabelle auf 55 vergrößert werden.</p>

<pre><code>ALTER TABLE `panel_ipsandports` CHANGE `ip` `ip` VARCHAR( 55 ) NOT NULL DEFAULT ''
</code></pre>

<p>Nun können unter <code>IPs und Ports</code> Dualstack-IPs angeben werden, indem die IPv4 einfach durch ein Leerzeichen von der IPv6-Adresse getrennt wird:</p>

<p><img src="/blog/www/images/2012/froxlor_ipv6.gif" alt="froxlor_ipv6" /></p>

<p>Achtung: der Patch berücksichtigt nur die Apache und Bind Konfiguration. NGIX und Lighttpd sind unverändert und somit wahrscheinlich nicht funktionsfähig.</p>

<h2>IPv6 und PHP</h2>

<p>Wenn die eigene Webseite auch per IPv6 erreichbar ist, kann das auch Auswirkungen auf PHP-Scripte haben. <code>$_SERVER['REMOTE_ADDR']</code> beinhaltet dann nämlich die IPv6-Adresse als String und die ist in den meisten Fällen deutlich länger als eine IPv4-Adresse. Das kann ein Problem werden, wenn die IP-Adresse in einer Datenbank als ein <code>VARCHAR(15)</code> gespeichert wird. Hier benötigt man nun ein <code>VARCHAR(40)</code>. Auch <a href="//php.net/manual/de/function.ip2long.php">ip2long()</a> funktioniert nicht mit IPv6-Adressen.</p>
        </article>                 <article>            <time pubdate>08. Januar 2012</time>            <h1><a href="/blog/www/2012/01/08/froxlor-bug-maximale-lange-von-serveralias-apache.html">Froxlor Bug: maximale Länge von ServerAlias (Apache)</a></h1>            <p>SysCP bzw. dessen Nachfolger <a href="http://www.froxlor.org/">Froxlor</a> kümmert sich hier auf diesem Server um das Erstellen diverser Konfigurationsdateien sowie um die Verwaltung der virtuellen User für E-Mail- und FTP-Zugänge.</p>

<p>Schon vor einiger Zeit habe ich festgestellt, dass bei Verwendung vieler Alias-Domains die erzeugte Apache-Konfiguration fehlerhaft sein kann. Dann nämlich, wenn die ServerAlias-Direktive mehr als 8000 Zeichen hat. Scheinbar hat noch keiner zuvor so viele Alias-Domains einer Hauptdomain hinzugefügt. 8000 Zeichen hört sich auch viel an, doch wenn pro Domain jeweils noch die www-Subdomain hinzukommt, reichen bereits ca. 150 Domains um dieses Limit zu erreichen.</p>

<p>Der Apache vHost-Container unterstützt mehrere ServerAlias-Direktiven, so dass bevor die 8000 Zeichen erreicht werden einfach ein neuer ServerAlias-Eintrag erzeugt werden sollte. Die Datei <code>cron_tasks.inc.http.10.apache.php</code> in <code>scripts/jobs</code> ist für das Erstellen der Apache-Konfigurationsdateien verantwortlich und mit wenigen Zeilen auf dieses Verhalten anpassbar (<a href="/blog/www/files/2012/01/ServerAlias.patch">Patch</a>).</p>

<p>Da ich nicht nach jedem Update daran denken möchte, diese Änderung einzuspielen, habe ich bei Froxlor mal ein <a href="http://redmine.froxlor.org/issues/1012">Ticket erstellt</a> und diesen Patch angehängt. Vielleicht schafft er es ja in die 0.9.27 :)</p>
        </article>                         <a href="/blog/www/archiv.html">Archiv &raquo;</a> 
    </div>    
    
    <aside>
        <h1>Seiten</h1>
        <ul>
            <li><a href="/blog/www/about.html">About me</a></li>
            <li><a href="/blog/www/archiv.html">Archiv</a></li>
        </ul>

        <h1>Interessantes</h1>
        <ul>
            <li><a href="/blog/www/2011/06/19/uber-primary-keys-in-urls-und-sonstwo.html">Über Primary-Keys in URLs .. und sonstwo</a></li>
            <li><a href="/blog/www/2010/02/15/spam-im-griff-mit-catch-all-e-mail-adresse-und-subdomain.html">SPAM im Griff mit Catch-All E-Mail-Adresse und Subdomain</a></li>
            <li><a href="/blog/www/2010/02/06/phps-pdo-klasse-erweitern.html">PHP's PDO-Klasse erweitern</a></li>

        </ul>

        <h1>Neue Beiträge</h1>
        <ul>
            <li><a href="/blog/www/2012/02/14/ipv6-und-die-dimension.html">IPv6 und die Dimension</a></li>
            <li><a href="/blog/www/2012/02/06/neuerungen-in-php-5-4.html">Neuerungen in PHP 5.4</a></li>
            <li><a href="/blog/www/2012/01/29/postfix-reject_sender_login_mismatch-pro-sasl-username.html">Postfix: reject_sender_login_mismatch pro SASL username</a></li>

        </ul>

        <h1>Kategorien</h1>
        <ul>
            <li><a href="/blog/www/allgemein.html">Allgemein</a></li>
            <li><a href="/blog/www/linux.html">Linux</a></li>
            <li><a href="/blog/www/webtechnik.html">Webtechnik</a></li>

        </ul>

        <h1>Blogroll</h1>
        <ul>
            <li><a href="http://blog.kevin-k.com/">kevin's blog</a></li>
        </ul> 
    </aside>

    <footer>
        <p><small>&copy;</small> 2012 neunzehn83.de, powered by <a href="#">lmsbe</a> | <a href="/blog/www/feed.xml">RSS</a></p>
    </footer>
</body>
</html> 
